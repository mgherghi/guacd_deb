#!/bin/bash
set -euo pipefail

GUAC_VERSION=1.6.0
BUILD_DIR=/usr/src/guacamole-build
OUT_DIR=/usr/src/guacd_bundle
CORES=$(nproc)

echo "[+] Installing build dependencies..."
sudo apt update
sudo apt install -y build-essential autotools-dev debhelper \
    dpkg-dev fakeroot devscripts \
    libcairo2-dev libjpeg62-turbo-dev libpng-dev libossp-uuid-dev \
    libavcodec-dev libavutil-dev libswscale-dev freerdp2-dev \
    libpango1.0-dev libssh2-1-dev libtelnet-dev libvncserver-dev \
    libpulse-dev libssl-dev libvorbis-dev libwebp-dev libwebsockets-dev \
    wget curl logrotate

mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

###############################################################################
# Download and prepare Guacamole Server
###############################################################################
echo "[+] Downloading guacamole-server ${GUAC_VERSION}..."
wget -q https://downloads.apache.org/guacamole/${GUAC_VERSION}/source/guacamole-server-${GUAC_VERSION}.tar.gz
tar -xzf guacamole-server-${GUAC_VERSION}.tar.gz
cd guacamole-server-${GUAC_VERSION}

###############################################################################
# Create Debian packaging (production ready)
###############################################################################
mkdir -p debian
cat > debian/control <<EOF
Source: guacamole-server
Section: net
Priority: optional
Maintainer: Guacamole Builder <builder@example.com>
Build-Depends: debhelper-compat (= 13), autotools-dev, \
 libcairo2-dev, libjpeg62-turbo-dev, libpng-dev, libossp-uuid-dev, \
 libavcodec-dev, libavutil-dev, libswscale-dev, freerdp2-dev, \
 libpango1.0-dev, libssh2-1-dev, libtelnet-dev, libvncserver-dev, \
 libpulse-dev, libssl-dev, libvorbis-dev, libwebp-dev, libwebsockets-dev, \
 logrotate
Standards-Version: 4.6.0
Homepage: https://guacamole.apache.org/

Package: guacamole-server
Architecture: any
Depends: libcairo2, libjpeg62-turbo, libpng16-16, libossp-uuid16, \
 libavcodec59, libavutil57, libswscale6, freerdp2-x11, \
 libpango-1.0-0, libssh2-1, libtelnet2, libvncserver1, \
 libpulse0, libssl3, libvorbis0a, libvorbisenc2, libwebp7, \
 libwebsockets17, ffmpeg, logrotate, \${misc:Depends}
Description: Guacamole remote desktop gateway (server daemon)
 guacd proxy daemon supporting RDP, VNC, SSH, Telnet, and more.
EOF

cat > debian/rules <<EOF
#!/usr/bin/make -f
%:
	dh \$@

override_dh_auto_configure:
	./configure --prefix=/usr --sysconfdir=/etc/guacamole --localstatedir=/var

override_dh_auto_build:
	\$(MAKE) -j${CORES}

override_dh_auto_test:
	# Disabled: skip unit tests
EOF
chmod +x debian/rules

cat > debian/changelog <<EOF
guacamole-server (${GUAC_VERSION}-1) stable; urgency=medium

  * Production-ready build of guacamole-server ${GUAC_VERSION} for Debian 12
  * Includes hardened systemd unit, default configs, and logrotate support

 -- Guacamole Builder <builder@example.com>  $(date -R)
EOF

# Config
mkdir -p debian/guacamole-server/etc/guacamole
cat > debian/guacamole-server/etc/guacamole/guacd.conf <<'EOF'
[server]
bind_host = 0.0.0.0
bind_port = 4822
pid_file = /var/run/guacd.pid
log_level = info
log_file = /var/log/guacd/guacd.log
EOF

# Systemd service
mkdir -p debian/guacamole-server/lib/systemd/system
cat > debian/guacamole-server/lib/systemd/system/guacd.service <<'EOF'
[Unit]
Description=Guacamole proxy daemon (guacd)
After=network.target
Documentation=https://guacamole.apache.org/

[Service]
ExecStart=/usr/sbin/guacd -f
User=guacd
Group=guacd
Restart=always
RestartSec=5

# Security Hardening
NoNewPrivileges=true
ProtectSystem=full
ProtectHome=true
PrivateTmp=true
ProtectKernelModules=true
ProtectKernelTunables=true
ProtectControlGroups=true
ReadWritePaths=/var/log/guacd /var/run

[Install]
WantedBy=multi-user.target
EOF

# Logrotate
mkdir -p debian/guacamole-server/etc/logrotate.d
cat > debian/guacamole-server/etc/logrotate.d/guacd <<'EOF'
/var/log/guacd/*.log {
    daily
    rotate 14
    compress
    missingok
    notifempty
    create 0640 guacd guacd
    sharedscripts
    postrotate
        systemctl kill -s HUP guacd.service >/dev/null 2>&1 || true
    endscript
}
EOF

# Post-install scripts
cat > debian/postinst <<'EOF'
#!/bin/bash
set -e
case "$1" in
    configure)
        if ! id -u guacd >/dev/null 2>&1; then
            adduser --system --group --no-create-home --home /var/lib/guacd guacd
        fi
        install -d -o guacd -g guacd /var/log/guacd
        systemctl daemon-reload
        systemctl enable --now guacd
        ;;
esac
exit 0
EOF
chmod 755 debian/postinst

cat > debian/postrm <<'EOF'
#!/bin/bash
set -e
case "$1" in
    remove|purge)
        systemctl disable --now guacd || true
        ;;
esac
exit 0
EOF
chmod 755 debian/postrm

###############################################################################
# Build package
###############################################################################
echo "[+] Building guacamole-server package..."
dpkg-buildpackage -us -uc -b -j${CORES}
cd "$BUILD_DIR"

GUAC_DEB=$(ls guacamole-server_${GUAC_VERSION}-1_amd64.deb)

###############################################################################
# Bundle with dependencies
###############################################################################
echo "[+] Preparing bundle with runtime dependencies..."
mkdir -p "$OUT_DIR"
cp "$GUAC_DEB" "$OUT_DIR/"

RUNTIME_DEPS="libcairo2 libjpeg62-turbo libpng16-16 libossp-uuid16 \
 libavcodec59 libavutil57 libswscale6 freerdp2-x11 \
 libpango-1.0-0 libssh2-1 libtelnet2 libvncserver1 \
 libpulse0 libssl3 libvorbis0a libvorbisenc2 libwebp7 \
 libwebsockets17 ffmpeg logrotate"

cd "$OUT_DIR"
for pkg in $RUNTIME_DEPS; do
    echo "  -> downloading $pkg ..."
    apt-get download "$pkg"
done

echo "[+] Creating bundle archive..."
cd "$(dirname "$OUT_DIR")"
tar czf guacd_bundle.tar.gz "$(basename "$OUT_DIR")"

###############################################################################
# Done
###############################################################################
echo
echo "[+] Build complete!"
echo "Bundle created at: $BUILD_DIR/../guacd_bundle.tar.gz"
echo
echo "To install on another node (even offline):"
echo "  tar xzf guacd_bundle.tar.gz"
echo "  cd guacd_bundle"
echo "  sudo dpkg -i *.deb"
echo "  sudo apt-get -f install -y"
